<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="/autobloom-deployed-prototype/favicon.ico" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="Affordable self-caring plants." />
    <link
      rel="apple-touch-icon"
      href="/autobloom-deployed-prototype/logo192.png"
    />
    <link rel="manifest" href="/autobloom-deployed-prototype/manifest.json" />
    <title>AutoBloom</title>
    <script
      defer="defer"
      src="/autobloom-deployed-prototype/static/js/main.b9b81b23.js"
    ></script>
    <link
      href="/autobloom-deployed-prototype/static/css/main.5a2a8526.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
    <script>
      class LineBreakTransformer {
        constructor() {
          this.container = "";
        }

        transform(chunk, controller) {
          this.container += chunk;
          const lines = this.container.split("\r\n");
          this.container = lines.pop();
          lines.forEach((line) => controller.enqueue(line));
        }

        flush(controller) {
          controller.enqueue(this.container);
        }
      }

      async function connectToSerial(usbVendorId = 0x2341) {
        try {
          const filter = { usbVendorId: usbVendorId };
          const port = await navigator.serial.requestPort({
            filters: [filter],
          });

          console.log("Found port");
          await port.open({ baudRate: 115200 });
          console.log("Ready to go!");

          return port;
        } catch (error) {
          console.error("Connection failed!", error);
          return null;
        }
      }

      async function readData(humidityLevelDOM) {
        while (port.readable) {
          const decoder = new TextDecoderStream();
          const streamClosed = port.readable.pipeTo(decoder.writable);
          const lineReader = decoder.readable
            .pipeThrough(new TransformStream(new LineBreakTransformer()))
            .getReader();

          try {
            while (true) {
              const { value, done } = await lineReader.read();
              if (done) {
                // |reader| has been canceled.
                break;
              }
              console.log("Value: ", value);

              let parsedData = parseData(value);
              console.log(parsedData);

              humidityLevelDOM.innerHTML = parseData["hum"];
            }
          } catch (error) {
            console.error("Error during reading: ", error);
          } finally {
            reader.releaseLock();
          }
        }
      }

      async function writeData(textData) {
        const encoder = new TextEncoder();
        const writer = port.writable.getWriter();
        await writer.write(encoder.encode(textData));
        writer.releaseLock();
      }

      function parseData(textData) {
        let splitStr = textData.split("|");
        if (splitStr.length != 2) return { moist: null, hum: null };

        return { moist: splitStr[0], hum: splitStr[1] };
      }

      window.onload = async () => {
        setTimeout(async () => {
          console.log("Ready");
          var humidityLevel = document.querySelector(
            "#root > div > div > div > div > div > div:nth-child(4) > div > div:nth-child(1) > div > h1"
          );

          var resyncBtn = document.querySelector(
            "#root > div > div > div > div > div > div.rt-Box.rt-r-mt-4 > div > button:nth-child(2)"
          );

          var waterNowBtn = document.querySelector(
            "#root > div > div > div > div > div > div.rt-Box.rt-r-mt-4 > div > button:nth-child(1)"
          );

          window.connectToSerial = connectToSerial;
          window.readData = readData;

          var port = null;

          if (resyncBtn) {
            resyncBtn.addEventListener("click", async () => {
              port = await connectToSerial(0x2341);

              if (port) {
                await readData(humidityLevel);
              }
            });
          }

          if (waterNowBtn) {
            waterNowBtn.addEventListener("click", async () => {
              if (port) {
                await writeData(77);
              }
            });
          }
        }, 1500);
      };
    </script>
  </body>
</html>
